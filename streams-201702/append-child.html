<!DOCTYPE html>
<title>Append Child WritableStream demo</title>
<script src="transform-stream-polyfill.js"></script>
<script src="text-encode-transform.js"></script>
<script src="parse-json.js"></script>
<script src="split-stream.js"></script>
<link rel=stylesheet href="common.css">
<style>
#commits {
    font-size: 16pt;
}

#commits th {
    text-align: left;
    padding: 2pt 4pt 2pt 4pt;
}

#commits tr:nth-child(even) {
    background-color: rgb(248, 248, 248);
}

#commits td {
    padding: 2pt 4pt 2pt 4pt;
}

#commits td:first-child {
    font-family: Consolas, monospace;
    font-size: 0.9em;
}
</style>
<h1>Append Child WritableStream demo</h1>
<div id=buttons>
  <button id="load">Load JSON stream</button>
  <button id="reset">Reset</button>
</div>
<div id=target></div>
<script>
const loadButton = document.querySelector('#load');
const resetButton = document.querySelector('#reset');
const target = document.querySelector('#target');
const FIELDS =  ['Hash', 'Date', 'Author', 'Subject'];
const FIELDS_LOWERCASE = FIELDS.map(string => string.toLowerCase());

function appendChildWritableStream(parentNode) {
  return new WritableStream({
    write(chunk) {
      parentNode.appendChild(chunk);
    }
  });
}

function createTable(parentElement) {
  const table = document.createElement('table');
  table.id = 'commits';
  const tr = document.createElement('tr');
  for (const heading of FIELDS) {
    const th = document.createElement('th');
    th.textContent = heading;
    tr.appendChild(th);
  }
  table.appendChild(tr);
  parentElement.appendChild(table);
  return table;
}

async function fetchThenJsonToDom() {
  loadButton.disabled = true;
  const jsonToElementTransform = new TransformStream({
    transform(chunk, controller) {
      const tr = document.createElement('tr');
      for (const cell of FIELDS_LOWERCASE) {
        const td = document.createElement('td');
        td.textContent = chunk[cell];
        tr.appendChild(td);
      }
      controller.enqueue(tr);
    }
  });

  const result = await fetch('commits.json',
                             {
                               mode: 'same-origin',
                               headers: {
                                 'Cache-Control': 'no-cache, no-store'
                               }
                             });
  const table = createTable(target);
  return result.body
    .pipeThrough(new TextDecoder())
    .pipeThrough(splitStream('\n'))
    .pipeThrough(parseJSON())
    .pipeThrough(jsonToElementTransform)
    .pipeTo(appendChildWritableStream(table));
}

loadButton.onclick = async () => {
  setTimeout(fetchThenJsonToDom, 0);
};

resetButton.onclick = () => {
  while (target.firstChild) {
    target.removeChild(target.firstChild);
  }
  loadButton.disabled = false;
}

</script>
